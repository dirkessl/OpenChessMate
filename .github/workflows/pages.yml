name: Deploy GitHub Pages

on:
  push:
    branches: [main]
    paths: ['docs/**']
  # Called by release.yml after creating a release, so the web installer
  # serves the latest firmware binaries from GitHub Pages (with CORS headers).
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download firmware from latest release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p docs/firmware
          for file in bootloader.bin partitions.bin boot_app0.bin firmware.bin littlefs.bin; do
            gh release download --repo "${{ github.repository }}" --pattern "$file" --dir docs/firmware 2>/dev/null || true
          done
          echo "=== Firmware files for web installer ==="
          ls -lh docs/firmware/ 2>/dev/null || echo "No release assets found (first deploy before any release)"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        timeout-minutes: 5
