<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenChess Home</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <div class="container">
        <h2>OpenChess Home</h2>
        <div class="status" id="status">Loading status...</div>

        <!-- WiFi Settings Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('wifi')">
                <span class="section-icon" id="wifi-icon">â–¶</span>
                <h3>WiFi Settings</h3>
            </div>
            <div class="section-content" id="wifi-content">
                <form id="wifiForm">
                    <div class="form-group">
                        <label for="ssid">WiFi SSID:</label>
                        <input type="text" name="ssid" id="ssid" value="" placeholder="Enter Your WiFi SSID">
                    </div>
                    <div class="form-group">
                        <label for="password">WiFi Password:</label>
                        <input type="text" name="password" id="password" value=""
                            placeholder="Enter Your WiFi Password">
                    </div>
                    <input type="submit" style="background-color: #4CAF50;" value="Connect to WiFi">
                </form>
                <div class="ota-auto-toggle">
                    <span>Scan All WiFi Channels</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="scanAllChannels">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p class="section-description" style="font-size: 12px; margin-top: 4px;">
                    Enable for mesh networks with multiple APs on the same SSID. Adds ~10s to connection time.
                </p>
            </div>
        </div>

        <!-- Lichess Settings Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('lichess')">
                <span class="section-icon" id="lichess-icon">â–¶</span>
                <h3>Lichess Settings</h3>
            </div>
            <div class="section-content" id="lichess-content">
                <p class="section-description">
                    Play Lichess games on your physical board.
                    <a href="https://lichess.org/account/oauth/token" target="_blank" style="color: #ec8703;">
                        Get your API token here
                    </a>
                </p>
                <div class="lichess-status" id="lichess-status">
                    <span id="lichess-token-status">No token configured</span>
                </div>
                <form id="lichessForm">
                    <div class="form-group">
                        <label for="lichessToken">API Token:</label>
                        <input type="password" name="lichessToken" id="lichessToken" value=""
                            placeholder="lip_xxxxxxxxxxxxx">
                    </div>
                    <input type="submit" style="background-color: #9c59b6;" value="Save Lichess Token">
                </form>
            </div>
        </div>

        <!-- Board Settings Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('board')">
                <span class="section-icon" id="board-icon">â–¶</span>
                <h3>Board Settings</h3>
            </div>
            <div class="section-content" id="board-content">
                <p class="section-description">
                    Adjust the LED brightness and dark square dimming for your chess board.
                </p>
                <form id="boardSettingsForm">
                    <div class="form-group">
                        <label for="brightness">LED Brightness: <span id="brightness-value">255</span></label>
                        <input type="range" id="brightness" name="brightness" min="10" max="255" value="255"
                            class="slider-input">
                    </div>
                    <div class="form-group">
                        <label for="dimMultiplier">Dark Square Dimming: <span id="dim-value">70</span>%</label>
                        <input type="range" id="dimMultiplier" name="dimMultiplier" min="20" max="100" value="70"
                            class="slider-input">
                    </div>
                    <input type="submit" style="background-color: #4CAF50;" value="Save LED Settings">
                </form>
                <div class="calibration-section">
                    <p class="section-description" style="margin-top: 15px; margin-bottom: 10px;">
                        Run board calibration to map LEDs and sensors to the correct squares.
                    </p>
                    <button type="button" id="calibrateBtn" class="button" style="background-color: #f44336;">
                        Start Board Calibration
                    </button>
                </div>
            </div>
        </div>

        <!-- Hardware Configuration Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('hwconfig')">
                <span class="section-icon" id="hwconfig-icon">â–¶</span>
                <h3>Hardware Configuration</h3>
            </div>
            <div class="section-content" id="hwconfig-content">
                <p class="section-description">
                    GPIO pin assignments and shift register settings. Changes require a reboot and re-calibration.
                </p>
                <form id="hwConfigForm">
                    <div class="form-group">
                        <label for="hw-ledPin">LED Strip Data Pin (GPIO)</label>
                        <input type="number" id="hw-ledPin" min="0" max="39" class="text-input">
                    </div>
                    <div class="form-group">
                        <label for="hw-srClkPin">Shift Register Clock Pin (SRCLK)</label>
                        <input type="number" id="hw-srClkPin" min="0" max="39" class="text-input">
                    </div>
                    <div class="form-group">
                        <label for="hw-srLatchPin">Shift Register Latch Pin (RCLK)</label>
                        <input type="number" id="hw-srLatchPin" min="0" max="39" class="text-input">
                    </div>
                    <div class="form-group">
                        <label for="hw-srDataPin">Shift Register Data Pin (SER)</label>
                        <input type="number" id="hw-srDataPin" min="0" max="39" class="text-input">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label for="hw-srInvert" style="margin-bottom: 0;">Invert Shift Register Outputs (PNP
                            transistors)</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="hw-srInvert">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Row Input Pins (GPIO)</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                            <input type="number" id="hw-row0" min="0" max="39" class="text-input" placeholder="Row 0">
                            <input type="number" id="hw-row1" min="0" max="39" class="text-input" placeholder="Row 1">
                            <input type="number" id="hw-row2" min="0" max="39" class="text-input" placeholder="Row 2">
                            <input type="number" id="hw-row3" min="0" max="39" class="text-input" placeholder="Row 3">
                            <input type="number" id="hw-row4" min="0" max="39" class="text-input" placeholder="Row 4">
                            <input type="number" id="hw-row5" min="0" max="39" class="text-input" placeholder="Row 5">
                            <input type="number" id="hw-row6" min="0" max="39" class="text-input" placeholder="Row 6">
                            <input type="number" id="hw-row7" min="0" max="39" class="text-input" placeholder="Row 7">
                        </div>
                    </div>
                    <input type="submit" style="background-color: #FF9800;" value="Save & Reboot">
                </form>
            </div>
        </div>

        <!-- OTA Updates Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('ota')">
                <span class="section-icon" id="ota-icon">â–¶</span>
                <h3>Software Updates</h3>
            </div>
            <div class="section-content" id="ota-content">
                <div class="ota-version-info" id="ota-version-info">
                    <span>Current version: </span><strong id="current-version">loading...</strong>
                </div>

                <div class="ota-auto-toggle">
                    <span>Automatic Updates</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoOtaToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <button type="button" id="checkUpdateBtn" class="button"
                    style="background-color: #2196F3; margin-top: 10px;">
                    Check for Updates Now
                </button>
                <div id="ota-status" class="ota-status" style="display:none;"></div>

                <div class="ota-manual-section">
                    <p class="section-description" style="margin-top: 15px; margin-bottom: 10px;">
                        Manual update: drag & drop firmware (.bin) or web assets (.tar) files below.
                    </p>
                    <div class="ota-drop-zone" id="otaDropZone">
                        <div class="ota-drop-icon">ðŸ“¦</div>
                        <div class="ota-drop-text">Drop <strong>.bin</strong> (firmware) or <strong>.tar</strong> (web
                            assets) here</div>
                        <div class="ota-drop-subtext">or click to select a file</div>
                        <input type="file" id="otaFileInput" accept=".bin,.tar" style="display:none;">
                    </div>
                    <div id="ota-upload-progress" class="ota-upload-progress" style="display:none;">
                        <div class="ota-progress-bar">
                            <div class="ota-progress-fill" id="otaProgressFill"></div>
                        </div>
                        <span id="ota-progress-text">Uploading...</span>
                    </div>
                </div>
            </div>
        </div>

        <a href="./game.html" class="button">GameMode Selection</a>
        <a href="./board.html" class="button">View Board</a>
    </div>
    <script>
        // Section toggle state
        const sectionStates = {
            wifi: false,
            lichess: false,
            board: false,
            hwconfig: false,
            ota: false
        };

        function toggleSection(name) {
            sectionStates[name] = !sectionStates[name];
            const content = document.getElementById(name + '-content');
            const icon = document.getElementById(name + '-icon');

            if (sectionStates[name]) {
                content.classList.add('expanded');
                icon.textContent = 'â–¼';
            } else {
                content.classList.remove('expanded');
                icon.textContent = 'â–¶';
            }
        }

        function updateWiFiInfo(retries = 0, maxRetries = 20) {
            fetch('/wifi')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('ssid').value = data.ssid;
                    document.getElementById('password').value = data.password;
                    document.getElementById('scanAllChannels').checked = data.scanAllChannels;
                    const isConnected = (data.connected || '').toString() === 'true';
                    const statusText = `SSID: ${data.ap_ssid} (${data.ap_ip})` + (isConnected ? ` | SSID: ${data.ssid} (${data.local_ip})` : ``);
                    document.getElementById('status').textContent = statusText;
                })
                .catch(() => {
                    if (retries < maxRetries) {
                        const delayMs = Math.min(500 + (retries * 300), 5000);
                        setTimeout(() => updateWiFiInfo(retries + 1, maxRetries), delayMs);
                    } else {
                        alert('Error fetching WiFi information. Please try again later.');
                    }
                });
        }

        function updateLichessInfo() {
            fetch('/lichess')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('lichess-token-status');
                    if (data.hasToken) {
                        statusEl.textContent = 'Token configured: ' + data.maskedToken;
                        statusEl.style.color = '#4CAF50';
                    } else {
                        statusEl.textContent = 'No token configured';
                        statusEl.style.color = '#f44336';
                    }
                })
                .catch(() => {
                    document.getElementById('lichess-token-status').textContent = 'Error loading status';
                });
        }

        // Fetch info on page load
        updateWiFiInfo();
        updateLichessInfo();
        updateBoardSettings();
        updateHardwareConfig();
        updateOtaSettings();

        // Board settings functions
        function updateBoardSettings() {
            fetch('/board-settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('brightness').value = data.brightness;
                    document.getElementById('brightness-value').textContent = data.brightness;
                    document.getElementById('dimMultiplier').value = data.dimMultiplier;
                    document.getElementById('dim-value').textContent = data.dimMultiplier;
                })
                .catch(() => {
                    console.log('Error loading board settings');
                });
        }

        // Update slider value displays in real-time
        document.getElementById('brightness').addEventListener('input', function () {
            document.getElementById('brightness-value').textContent = this.value;
        });

        document.getElementById('dimMultiplier').addEventListener('input', function () {
            document.getElementById('dim-value').textContent = this.value;
        });

        // Handle board settings form submission
        document.getElementById('boardSettingsForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const brightness = document.getElementById('brightness').value;
            const dimMultiplier = document.getElementById('dimMultiplier').value;

            const formData = new URLSearchParams();
            formData.append('brightness', brightness);
            formData.append('dimMultiplier', dimMultiplier);

            fetch('/board-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        alert('LED settings saved successfully!');
                    } else {
                        alert('Failed to save settings. Please try again.');
                    }
                })
                .catch(() => {
                    alert('Error saving settings. Please try again.');
                });
        });

        // Hardware config functions
        function updateHardwareConfig() {
            fetch('/hardware-config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('hw-ledPin').value = data.ledPin;
                    document.getElementById('hw-srClkPin').value = data.srClkPin;
                    document.getElementById('hw-srLatchPin').value = data.srLatchPin;
                    document.getElementById('hw-srDataPin').value = data.srDataPin;
                    document.getElementById('hw-srInvert').checked = data.srInvertOutputs;
                    for (let i = 0; i < data.rowPins.length; i++) {
                        document.getElementById('hw-row' + i).value = data.rowPins[i];
                    }
                })
                .catch(() => {
                    console.log('Error loading hardware config');
                });
        }

        document.getElementById('hwConfigForm').addEventListener('submit', function (e) {
            e.preventDefault();
            if (!confirm('This will save the new pin configuration, clear calibration, and reboot the board. Continue?')) return;

            const formData = new URLSearchParams();
            formData.append('ledPin', document.getElementById('hw-ledPin').value);
            formData.append('srClkPin', document.getElementById('hw-srClkPin').value);
            formData.append('srLatchPin', document.getElementById('hw-srLatchPin').value);
            formData.append('srDataPin', document.getElementById('hw-srDataPin').value);
            formData.append('srInvertOutputs', document.getElementById('hw-srInvert').checked ? '1' : '0');
            for (let i = 0; i < 8; i++) {
                formData.append('rowPin' + i, document.getElementById('hw-row' + i).value);
            }

            fetch('/hardware-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            })
                .then(response => response.text())
                .then(data => {
                    alert(data);
                })
                .catch(() => {
                    alert('Error saving hardware config.');
                });
        });

        // Handle calibration button
        document.getElementById('calibrateBtn').addEventListener('click', function () {
            if (confirm('This will clear the current board calibration. The board will need to be calibrated on the next reboot. Continue?')) {
                fetch('/board-calibrate', {
                    method: 'POST'
                })
                    .then(response => response.text())
                    .then(data => {
                        alert(data);
                    })
                    .catch(() => {
                        alert('Error starting calibration. Please try again.');
                    });
            }
        });

        // Handle scan all channels toggle (save immediately on change)
        document.getElementById('scanAllChannels').addEventListener('change', function () {
            const formData = new URLSearchParams();
            formData.append('scanAllChannels', this.checked ? '1' : '0');
            fetch('/wifi', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            }).catch(() => { console.log('Error saving scan setting'); });
        });

        // Handle WiFi form submission
        document.getElementById('wifiForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;

            document.getElementById('status').textContent = 'Connecting...';

            const formData = new URLSearchParams();
            formData.append('ssid', ssid);
            formData.append('password', password);
            formData.append('scanAllChannels', document.getElementById('scanAllChannels').checked ? '1' : '0');
            formData.append('scanAllChannels', document.getElementById('scanAllChannels').checked ? '1' : '0');

            fetch('/wifi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
                .then(response => response.text())
                .then(data => {
                    if (data === 'OK')
                        setTimeout(() => updateWiFiInfo(0, 20), 1000);
                    else
                        alert('Bad credentials or already connected to this WiFi.');

                })
                .catch(() => {
                    document.getElementById('status').textContent = 'Connecting... (retrying)';
                    setTimeout(() => updateWiFiInfo(0, 20), 1000);
                });
        });

        // Handle Lichess form submission
        document.getElementById('lichessForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const token = document.getElementById('lichessToken').value;

            if (token.length < 10) {
                alert('Please enter a valid Lichess API token');
                return;
            }

            const formData = new URLSearchParams();
            formData.append('token', token);

            fetch('/lichess', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        alert('Lichess token saved successfully!');
                        document.getElementById('lichessToken').value = '';
                        updateLichessInfo();
                    } else {
                        alert('Failed to save token. Please try again.');
                    }
                })
                .catch(() => {
                    alert('Error saving token. Please try again.');
                });
        });

        // ========== OTA Updates ==========

        function updateOtaSettings() {
            fetch('/ota/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('current-version').textContent = (data.version == 'dev' ? data.version : 'v' + data.version);
                    document.getElementById('autoOtaToggle').checked = data.autoUpdate;
                })
                .catch(() => {
                    document.getElementById('current-version').textContent = 'unknown';
                });
        }

        // Auto-update toggle
        document.getElementById('autoOtaToggle').addEventListener('change', function () {
            const formData = new URLSearchParams();
            formData.append('autoUpdate', this.checked ? '1' : '0');
            fetch('/ota/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            }).catch(() => { });
        });

        // Check for updates button
        document.getElementById('checkUpdateBtn').addEventListener('click', function () {
            const statusEl = document.getElementById('ota-status');
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Checking...';
            statusEl.style.display = 'block';
            statusEl.textContent = 'Checking for updates...';
            statusEl.className = 'ota-status';

            fetch('/ota/check')
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.textContent = 'Check for Updates Now';
                    if (data.available) {
                        statusEl.textContent = 'Update available: v' + data.version;
                        statusEl.className = 'ota-status ota-status-available';
                        if (confirm('Update to v' + data.version + '?\n\nThis will update firmware and web assets. The board will reboot.')) {
                            statusEl.textContent = 'Updating... Do not power off the board!';
                            fetch('/ota/apply', { method: 'POST' })
                                .then(r => r.text())
                                .then(msg => {
                                    statusEl.textContent = msg;
                                    // Board will reboot, so we'll lose connection
                                    setTimeout(() => {
                                        statusEl.textContent = 'Board is rebooting... Refresh this page in a few seconds.';
                                    }, 3000);
                                })
                                .catch(() => {
                                    statusEl.textContent = 'Update failed. Please try again.';
                                    statusEl.className = 'ota-status ota-status-error';
                                });
                        }
                    } else {
                        statusEl.textContent = 'Firmware is up to date (v' + data.currentVersion + ')';
                        statusEl.className = 'ota-status ota-status-uptodate';
                    }
                })
                .catch(() => {
                    btn.disabled = false;
                    btn.textContent = 'Check for Updates Now';
                    statusEl.textContent = 'Failed to check for updates. Is WiFi connected?';
                    statusEl.className = 'ota-status ota-status-error';
                });
        });

        // Drag & Drop OTA upload
        const dropZone = document.getElementById('otaDropZone');
        const fileInput = document.getElementById('otaFileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleOtaFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleOtaFile(e.target.files[0]);
            e.target.value = '';
        });

        function handleOtaFile(file) {
            const name = file.name.toLowerCase();
            let endpoint = '';
            let typeLabel = '';

            if (name.endsWith('.bin')) {
                endpoint = '/ota/upload/firmware';
                typeLabel = 'firmware';
            } else if (name.endsWith('.tar')) {
                endpoint = '/ota/upload/web';
                typeLabel = 'web assets';
            } else {
                alert('Unsupported file type. Please use .bin (firmware) or .tar (web assets).');
                return;
            }

            if (!confirm('Upload ' + file.name + ' as ' + typeLabel + ' update?\n\n' +
                (typeLabel === 'firmware' ? 'The board will reboot after update.' : 'Web assets will be updated (saved games preserved).'))) {
                return;
            }

            const progressEl = document.getElementById('ota-upload-progress');
            const progressFill = document.getElementById('otaProgressFill');
            const progressText = document.getElementById('ota-progress-text');
            progressEl.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Uploading ' + typeLabel + '...';

            const xhr = new XMLHttpRequest();
            xhr.open('POST', endpoint);

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    progressFill.style.width = pct + '%';
                    progressText.textContent = 'Uploading ' + typeLabel + '... ' + pct + '%';
                }
            });

            xhr.onload = function () {
                if (xhr.status === 200) {
                    progressFill.style.width = '100%';
                    progressText.textContent = typeLabel === 'firmware'
                        ? 'Firmware updated! Board is rebooting...'
                        : 'Web assets updated successfully!';
                    progressFill.style.backgroundColor = '#4CAF50';
                    if (typeLabel === 'web assets') {
                        setTimeout(() => { progressEl.style.display = 'none'; }, 3000);
                    }
                } else {
                    progressText.textContent = 'Upload failed: ' + xhr.responseText;
                    progressFill.style.backgroundColor = '#f44336';
                }
            };

            xhr.onerror = function () {
                progressText.textContent = 'Upload error. Check connection.';
                progressFill.style.backgroundColor = '#f44336';
            };

            xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            xhr.setRequestHeader('X-File-Name', file.name);
            xhr.send(file);
        }
    </script>
</body>

</html>